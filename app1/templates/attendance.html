{% extends 'base.html' %}

{% block content %}
{% csrf_token %}
{% if request.user.role == 'User' or request.user.role == 'Branch User' %}
    <script>
        window.location.href = "{% url 'attendance_user' %}";
    </script>
{% else %}
<div class="allbody" style="overflow: hidden;">
<div class="container-fluid py-4">
    <!-- Header Section with Filters -->
    <div class="card shadow-sm mb-4" style="width: 95%;">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-12">
                    <h2 class="card-title text-center mb-0">Attendance Management</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Calendar Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Select Month</label>
                    <input type="month" class="form-control" id="monthFilter" 
                           value="{{ current_month|default:'' }}" 
                           onchange="updateAttendanceTable(this.value)">
                </div>
                <div class="col-md-4">
                    <label class="form-label">Department</label>
                    <select class="form-select" id="departmentFilter" onchange="filterEmployees()">
                        <option value="">All Departments</option>
                        <option value="IT">IT</option>
                        <option value="HR">HR</option>
                        <option value="Finance">Finance</option>
                        <option value="Marketing">Marketing</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Job Title</label>
                    <select class="form-select" id="jobTitleFilter" onchange="filterEmployees()">
                        <option value="">All Positions</option>
                        <option value="Manager">Manager</option>
                        <option value="Developer">Developer</option>
                        <option value="Designer">Designer</option>
                        <option value="Analyst">Analyst</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm bg-primary text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Overall Attendance</h6>
                            <h3 class="card-title mb-0" id="overallAttendance">0%</h3>
                        </div>
                        <i class="fas fa-chart-line fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm bg-success text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Full Days</h6>
                            <h3 class="card-title mb-0" id="fullDaysCount">0</h3>
                        </div>
                        <i class="fas fa-calendar-check fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm bg-warning text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Half Days</h6>
                            <h3 class="card-title mb-0" id="halfDaysCount">0</h3>
                        </div>
                        <i class="fas fa-calendar-minus fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm bg-danger text-white">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="card-subtitle mb-2">Leaves</h6>
                            <h3 class="card-title mb-0" id="leavesCount">0</h3>
                        </div>
                        <i class="fas fa-calendar-times fa-2x opacity-50"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Legend Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex gap-4">
                <div class="d-flex align-items-center">
                    <i class="fas fa-star text-success me-2"></i>
                    <span>Full Day</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-star-half-alt text-warning me-2"></i>
                    <span>Half Day</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-star text-danger me-2"></i>
                    <span>Leave</span>
                </div>
                <div class="d-flex align-items-center">
                    <i class="fas fa-star text-secondary me-2"></i>
                    <span>Not Marked</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Add this modal after the statistics cards section -->
    <div class="modal fade" id="attendanceDetailsModal" tabindex="-1" aria-labelledby="attendanceDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="attendanceDetailsModalLabel">Attendance Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="attendanceForm">
                        <div class="mb-3">
                            <label class="form-label">Employee Name</label>
                            <input type="text" class="form-control" id="employeeName" readonly>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Date</label>
                            <div class="form-control" id="attendanceDate" readonly></div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="attendanceStatus">
                                <option value="full">Full Day</option>
                                <option value="half">Half Day</option>
                                <option value="leave">Leave</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Punch In Time</label>
                            <div class="form-control" id="punchInDisplay">Not punched in</div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Punch Out Time</label>
                            <div class="form-control" id="punchOutDisplay">Not punched out</div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveAttendance()">Save changes</button>
                </div>
            </div>
        </div>
    </div>
</div></div>

    <!-- Attendance Table -->
    <div style="overflow: scroll;">
        <div class="card shadow-sm">
            <div class="card-body">
                <table class="table table-hover table-bordered">
                    <thead class="table-light">
                        <tr>
                            <th rowspan="3" class="align-middle">No</th>
                            <th rowspan="3" class="align-middle">Name</th>
                            <th rowspan="3" class="align-middle">User ID</th>
                            <th rowspan="3" class="align-middle">Job Title</th>
                            <th id="daysHeader" colspan="31" class="text-center">Days of Month</th>
                            <th rowspan="3" class="align-middle">Attendance %</th>
                        </tr>
                        <tr id="dayNumbers">
                            <!-- Day numbers will be populated by JavaScript -->
                        </tr>
                        <tr id="dayNames">
                            <!-- Day names will be populated by JavaScript -->
                        </tr>
                    </thead>
                    <tbody id="attendanceBody">
                        {% for employee in employees %}
                        <tr data-employee-id="{{ employee.id }}">
                            <td>{{ forloop.counter }}</td>
                            <td>{{ employee.name }}</td>
                            <td>{{ employee.user.userid|default:'' }}</td>
                            <td>{{ employee.job_title }}</td>
                            <!-- Individual cells for each day will be populated by JavaScript -->
                            <td class="attendance-percentage">0%</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div></div>

<!-- Add Font Awesome for icons -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<!-- Custom CSS -->
<style>
    .card {
        border-radius: 10px;
        border: none;
        transition: all 0.3s ease;
    }
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .table {
        width: 100%;
        margin-bottom: 0;
    }
    .table th {
        background-color: #f8f9fa;
        font-weight: 600;
        white-space: nowrap;
        min-width: 40px;
    }
    .table td {
        white-space: nowrap;
        min-width: 40px;
    }
    .attendance-marker {
        transition: all 0.3s ease;
    }
    .attendance-marker:hover {
        opacity: 0.8;
    }
    .form-select, .form-control {
        border-radius: 8px;
    }
    .btn {
        border-radius: 8px;
        padding: 0.5rem 1rem;
    }
    .current-day {
        background-color: #e8f4ff !important;
    }
    .weekend {
        background-color: #f8f9fa;
    }
    .future-day {
        background-color: #f5f5f5;
        pointer-events: none;
    }
    .future-day i {
        opacity: 0.5;
    }
    
    /* .table th:nth-child(1) { min-width: 50px; } 
    .table th:nth-child(2) { min-width: 150px; } 
    .table th:nth-child(3) { min-width: 100px; }  */
    /* .table th:nth-child(4) { min-width: 120px; }  */
    /* .table th:last-child { min-width: 100px; }   */
</style>

<script>
    // Get days in month helper function
    function getDaysInMonth(year, month) {
        return new Date(year, month, 0).getDate();
    }

    // Get month name helper function
    function getMonthName(date) {
        return new Intl.DateTimeFormat('en-US', { month: 'long' }).format(date);
    }

    function updateAttendanceTable(selectedDate) {
        if (!selectedDate) {
            const now = new Date();
            selectedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        }

        const [year, month] = selectedDate.split('-');
        const daysInMonth = getDaysInMonth(year, month);
        const currentDate = new Date();
        const selectedMonthDate = new Date(year, month - 1);
        
        // Update table header
        const daysHeader = document.getElementById('daysHeader');
        daysHeader.setAttribute('colspan', daysInMonth);
        
        // Update day numbers and names rows
        const dayNumbersRow = document.getElementById('dayNumbers');
        const dayNamesRow = document.getElementById('dayNames');
        dayNumbersRow.innerHTML = '';
        dayNamesRow.innerHTML = '';
        
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month - 1, day);
            const isWeekend = date.getDay() === 0 || date.getDay() === 6;
            const isFuture = date > currentDate;
            const isToday = date.toDateString() === currentDate.toDateString();
            
            // Add day number
            const thNumber = document.createElement('th');
            thNumber.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}`;
            thNumber.textContent = day;
            dayNumbersRow.appendChild(thNumber);
            
            // Add day name
            const thName = document.createElement('th');
            thName.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}`;
            thName.textContent = dayNames[date.getDay()];
            thName.style.fontSize = '0.8rem';
            dayNamesRow.appendChild(thName);
        }

        // Update attendance cells for each employee
        document.querySelectorAll('#attendanceBody tr').forEach(row => {
            // Remove any existing day cells (except the fixed columns)
            const fixedCells = Array.from(row.children).slice(0, 4);
            const percentageCell = row.children[row.children.length - 1];
            row.innerHTML = '';
            
            // Add back the fixed cells
            fixedCells.forEach(cell => row.appendChild(cell));
            
            // Get employee ID from the data attribute
            const employeeId = row.getAttribute('data-employee-id');
            
            // Add attendance cells for each day
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month - 1, day);
                const isWeekend = date.getDay() === 0 || date.getDay() === 6;
                const isFuture = date > currentDate;
                const isToday = date.toDateString() === currentDate.toDateString();
                
                const td = document.createElement('td');
                td.className = `text-center${isWeekend ? ' weekend' : ''}${isToday ? ' current-day' : ''}${isFuture ? ' future-day' : ''}`;
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-star attendance-marker';
                
                // Get attendance status from Django template context
                const attendanceData = JSON.parse('{{ attendance_data|safe }}');
                let state = 'initial';
                let iconColor = '#ccc';
                let tooltipText = '';
                
                if (attendanceData[employeeId] && attendanceData[employeeId][day]) {
                    const dayData = attendanceData[employeeId][day];
                    state = dayData.status;
                    
                    // Set icon class and color based on status
                    switch(state) {
                        case 'full':
                            icon.className = 'fas fa-star text-success';
                            iconColor = '#198754';
                            tooltipText = `Full Day (In: ${dayData.punch_in}, Out: ${dayData.punch_out})`;
                            break;
                        case 'half':
                            icon.className = 'fas fa-star-half-alt text-warning';
                            iconColor = '#ffc107';
                            tooltipText = `Half Day (In: ${dayData.punch_in})`;
                            break;
                        case 'leave':
                            icon.className = 'fas fa-star text-danger';
                            iconColor = '#dc3545';
                            tooltipText = 'Leave';
                            break;
                        default:
                            icon.className = 'fas fa-star text-secondary';
                            iconColor = '#ccc';
                            tooltipText = 'Not Marked';
                    }
                }
                
                icon.setAttribute('data-state', state);
                icon.style.cursor = 'pointer';
                icon.style.color = iconColor;
                icon.style.transition = 'all 0.3s ease';
                
                // Add tooltip
                if (tooltipText) {
                    icon.setAttribute('title', tooltipText);
                    icon.setAttribute('data-bs-toggle', 'tooltip');
                    icon.setAttribute('data-bs-placement', 'top');
                }
                
                // Add click handler for attendance markers
                if (!isFuture) {
                    icon.setAttribute('onmouseover', "this.style.transform='scale(1.2)'");
                    icon.setAttribute('onmouseout', "this.style.transform='scale(1)'");
                    
                    // Add click event listener with correct date handling
                    icon.onclick = function() {
                        const employeeName = row.children[1].textContent;
                        // Create date string in YYYY-MM-DD format without timezone issues
                        const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        showAttendanceModal(employeeId, employeeName, dateStr, this);
                    };
                }
                
                td.appendChild(icon);
                row.appendChild(td);
            }
            
            // Add back the percentage cell
            row.appendChild(percentageCell);
            
            // Update attendance percentage for this row
            updateAttendancePercentage(row);
        });

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        updateAttendanceStats();
    }

    function updateAttendancePercentage(row) {
        const markers = row.querySelectorAll('.attendance-marker:not(.future-day .attendance-marker)');
        let fullDays = 0;
        let halfDays = 0;
        
        markers.forEach(marker => {
            const state = marker.getAttribute('data-state');
            if (state === 'full') fullDays++;
            if (state === 'half') halfDays += 0.5;
        });

        const totalDays = markers.length;
        const percentage = ((fullDays + halfDays) / totalDays * 100).toFixed(1);
        row.querySelector('.attendance-percentage').textContent = `${percentage}%`;
    }

    function updateAttendanceStats() {
        const markers = document.querySelectorAll('.attendance-marker:not(.future-day .attendance-marker)');
        let fullDays = 0;
        let halfDays = 0;
        let leaves = 0;

        markers.forEach(marker => {
            const state = marker.getAttribute('data-state');
            if (state === 'full') fullDays++;
            if (state === 'half') halfDays++;
            if (state === 'leave') leaves++;

            // Add click handler for attendance markers
            if (!marker.closest('.future-day')) {
                marker.style.cursor = 'pointer';
                marker.onclick = function() {
                    const row = this.closest('tr');
                    const employeeId = row.getAttribute('data-employee-id');
                    const employeeName = row.children[1].textContent;
                    const date = new Date(year, month - 1, parseInt(this.closest('td').previousElementSibling.textContent));
                    showAttendanceModal(employeeId, employeeName, date.toISOString().split('T')[0], this);
                };
            }
        });

        const totalDays = markers.length;
        const overallPercentage = ((fullDays + (halfDays * 0.5)) / totalDays * 100).toFixed(1);

        document.getElementById('overallAttendance').textContent = `${overallPercentage}%`;
        document.getElementById('fullDaysCount').textContent = fullDays;
        document.getElementById('halfDaysCount').textContent = halfDays;
        document.getElementById('leavesCount').textContent = leaves;
    }

    function filterEmployees() {
        const department = document.getElementById('departmentFilter').value.toLowerCase();
        const jobTitle = document.getElementById('jobTitleFilter').value.toLowerCase();
        
        const rows = document.querySelectorAll('#attendanceBody tr');
        
        rows.forEach(row => {
            const deptMatch = !department || row.children[3].textContent.toLowerCase().includes(department);
            const jobMatch = !jobTitle || row.children[3].textContent.toLowerCase().includes(jobTitle);
            
            row.style.display = (deptMatch && jobMatch) ? '' : 'none';
        });
    }

    // Initialize the table with current month on page load
    document.addEventListener('DOMContentLoaded', function() {
        const now = new Date();
        const currentMonth = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        document.getElementById('monthFilter').value = currentMonth;
        updateAttendanceTable(currentMonth);
    });

    // Add this function to update a single attendance cell
    function updateAttendanceCell(employeeId, day, status, punchIn, punchOut) {
        const row = document.querySelector(`tr[data-employee-id="${employeeId}"]`);
        if (!row) return;
        
        // Find the cell for this day (add 4 to account for the fixed columns)
        const cell = row.children[day + 3];
        if (!cell) return;
        
        const icon = cell.querySelector('.attendance-marker');
        if (!icon) return;
        
        let iconClass = 'fas fa-star text-secondary';
        let iconColor = '#ccc';
        let tooltipText = 'Not Marked';
        
        switch(status) {
            case 'full':
                iconClass = 'fas fa-star text-success';
                iconColor = '#198754';
                tooltipText = `Full Day (In: ${punchIn}, Out: ${punchOut})`;
                break;
            case 'half':
                iconClass = 'fas fa-star-half-alt text-warning';
                iconColor = '#ffc107';
                tooltipText = `Half Day (In: ${punchIn})`;
                break;
            case 'leave':
                iconClass = 'fas fa-star text-danger';
                iconColor = '#dc3545';
                tooltipText = 'Leave';
                break;
        }
        
        icon.className = iconClass;
        icon.style.color = iconColor;
        icon.setAttribute('data-state', status);
        
        // Update tooltip
        icon.setAttribute('title', tooltipText);
        icon.setAttribute('data-bs-toggle', 'tooltip');
        icon.setAttribute('data-bs-placement', 'top');
        
        // Refresh tooltip
        const tooltip = bootstrap.Tooltip.getInstance(icon);
        if (tooltip) {
            tooltip.dispose();
        }
        new bootstrap.Tooltip(icon);
        
        // Update attendance percentage
        updateAttendancePercentage(row);
        updateAttendanceStats();
    }

    // Add this code to the punch-in click handler
    document.getElementById('punchInBtn').addEventListener('click', function() {
        fetch('/punch_in/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update the attendance star
                updateAttendanceCell(data.employee_id, parseInt(data.day), data.status, data.punch_in, null);
                
                // Show success message
                alert('Punched in successfully!');
            } else {
                alert(data.error || 'Failed to punch in');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Failed to punch in');
        });
    });

    // Add these new functions after updateAttendanceTable function
    function showAttendanceModal(employeeId, employeeName, date, icon) {
        const modal = new bootstrap.Modal(document.getElementById('attendanceDetailsModal'));
        const form = document.getElementById('attendanceForm');
        const nameInput = document.getElementById('employeeName');
        const dateDisplay = document.getElementById('attendanceDate');
        const statusSelect = document.getElementById('attendanceStatus');
        const punchInDisplay = document.getElementById('punchInDisplay');
        const punchOutDisplay = document.getElementById('punchOutDisplay');

        // Set employee name
        nameInput.value = employeeName;
        
        // Parse the date string directly (format: YYYY-MM-DD)
        const [year, month, day] = date.split('-').map(Number);
        // Create date object for midnight on the target date
        const displayDate = new Date(year, month - 1, day);
        dateDisplay.textContent = displayDate.toLocaleDateString('en-US', {
            weekday: 'long',
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Get current status from icon
        const currentState = icon.getAttribute('data-state');
        statusSelect.value = currentState || 'initial';

        // Get attendance data from Django template context
        const attendanceData = JSON.parse('{{ attendance_data|safe }}');
        const dayData = attendanceData[employeeId] && attendanceData[employeeId][parseInt(day)];

        if (dayData) {
            // Display punch in time if exists
            if (dayData.punch_in && dayData.punch_in !== 'None') {
                const punchInDate = new Date(dayData.punch_in);
                punchInDisplay.textContent = punchInDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } else {
                punchInDisplay.textContent = 'Not punched in';
            }

            // Display punch out time if exists
            if (dayData.punch_out && dayData.punch_out !== 'None') {
                const punchOutDate = new Date(dayData.punch_out);
                punchOutDisplay.textContent = punchOutDate.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: true
                });
            } else {
                punchOutDisplay.textContent = 'Not punched out';
            }
        } else {
            punchInDisplay.textContent = 'Not punched in';
            punchOutDisplay.textContent = 'Not punched out';
        }

        // Store current icon element for later use
        form.setAttribute('data-icon-element', icon.outerHTML);
        form.setAttribute('data-employee-id', employeeId);
        form.setAttribute('data-date', date);

        modal.show();
    }

    function saveAttendance() {
        const form = document.getElementById('attendanceForm');
        const employeeId = form.getAttribute('data-employee-id');
        const date = form.getAttribute('data-date');
        const status = document.getElementById('attendanceStatus').value;

        // Format the date string for the request
        const formattedDate = new Date(date);
        const day = formattedDate.getDate();

        // Show loading toast
        const loadingToast = showToast('Saving attendance...', 'info');

        // Get the existing attendance data
        const attendanceData = JSON.parse('{{ attendance_data|safe }}');
        const dayData = attendanceData[employeeId] && attendanceData[employeeId][day];

        fetch('/save_attendance/' + employeeId + '/' + day + '/' + status + '/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                punch_in: dayData ? dayData.punch_in : null,
                punch_out: dayData ? dayData.punch_out : null
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Update the attendance cell with existing punch times
                updateAttendanceCell(employeeId, day, status, 
                    dayData ? dayData.punch_in : '', 
                    dayData ? dayData.punch_out : '');
                showToast('Attendance saved successfully!', 'success');
                
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('attendanceDetailsModal'));
                modal.hide();
            } else {
                showToast('Error saving attendance: ' + data.message, 'error');
            }
        })
        .catch(error => {
            showToast('Error saving attendance: ' + error, 'error');
            console.error('Error:', error);
        })
        .finally(() => {
            if (loadingToast) {
                loadingToast.close();
            }
        });
    }

    // Add toast notification styles
    const toastStyles = document.createElement('style');
    toastStyles.textContent = `
        .toast.success { background-color: #d4edda; }
        .toast.error { background-color: #f8d7da; }
        .toast.info { background-color: #cce5ff; }
    `;
    document.head.appendChild(toastStyles);

    // Helper function to show toast notifications
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast position-fixed top-0 end-0 m-3 ${type}`;
        toast.style.zIndex = '1050';
        toast.innerHTML = `
            <div class="toast-header">
                <strong class="me-auto">${type.charAt(0).toUpperCase() + type.slice(1)}</strong>
                <button type="button" class="btn-close" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        `;
        document.body.appendChild(toast);
        
        const bsToast = new bootstrap.Toast(toast, {
            autohide: true,
            delay: 3000
        });
        bsToast.show();
        
        toast.addEventListener('hidden.bs.toast', () => {
            toast.remove();
        });
        
        return bsToast;
    }
</script>
{% endif %}
{% endblock %}