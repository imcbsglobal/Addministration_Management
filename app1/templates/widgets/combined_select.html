{# templates/widgets/combined_select.html #}
{% load static %}

<div class="combined-select-container">
    <div class="selected-items mb-2">
        {% for value in widget.value %}
            <span class="badge bg-primary me-1 mb-1">
                {{ value }}
                <button type="button" class="btn-close btn-close-white" aria-label="Remove"></button>
            </span>
        {% endfor %}
    </div>
    
    <div class="input-group">
        <select class="form-select combined-select" style="display: none;">
            <optgroup label="Software">
                {% for value, label in widget.software_choices %}
                    <option value="{{ label }}" data-type="software">{{ label }}</option>
                {% endfor %}
            </optgroup>
            <optgroup label="Requirements">
                {% for value, label in widget.choices %}
                    <option value="{{ label }}" data-type="requirement">{{ label }}</option>
                {% endfor %}
            </optgroup>
        </select>
        <button type="button" class="btn btn-primary add-item">
            <i class="fas fa-plus"></i> Add
        </button>
    </div>
    
    <input type="hidden" name="{{ widget.name }}" value="{{ widget.value|join:',' }}" />
</div>

<style>
.combined-select-container .badge {
    display: inline-flex;
    align-items: center;
    padding: 0.5em 0.7em;
}

.combined-select-container .btn-close {
    margin-left: 0.5em;
    font-size: 0.7em;
    padding: 0.5em;
}

.combined-select {
    margin-bottom: 0.5em;
}

.add-item {
    min-width: 80px;
}

.selected-items {
    min-height: 38px;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    padding: 0.375rem;
    background-color: #fff;
}

.selected-items:empty {
    padding: 1rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const containers = document.querySelectorAll('.combined-select-container');
    
    containers.forEach(container => {
        const select = container.querySelector('.combined-select');
        const addButton = container.querySelector('.add-item');
        const selectedContainer = container.querySelector('.selected-items');
        const hiddenInput = container.querySelector('input[type="hidden"]');
        
        // Initialize the hidden input with existing values
        updateHiddenInput();
        
        addButton.addEventListener('click', function() {
            if (select.style.display === 'none') {
                select.style.display = 'block';
                select.focus();
            } else {
                select.style.display = 'none';
            }
        });
        
        select.addEventListener('change', function() {
            const option = select.selectedOptions[0];
            const value = option.value;
            
            // Check if value already exists
            const existingBadges = selectedContainer.querySelectorAll('.badge');
            for (let badge of existingBadges) {
                if (badge.textContent.trim() === value) {
                    select.style.display = 'none';
                    select.selectedIndex = 0;
                    return;
                }
            }
            
            // Add badge
            const badge = document.createElement('span');
            badge.className = 'badge bg-primary me-1 mb-1';
            badge.innerHTML = `
                ${value}
                <button type="button" class="btn-close btn-close-white" aria-label="Remove"></button>
            `;
            
            selectedContainer.appendChild(badge);
            
            // Update hidden input
            updateHiddenInput();
            
            // Hide select and reset selection
            select.style.display = 'none';
            select.selectedIndex = 0;
        });
        
        // Handle clicks on remove buttons
        selectedContainer.addEventListener('click', function(e) {
            if (e.target.classList.contains('btn-close')) {
                e.target.parentElement.remove();
                updateHiddenInput();
            }
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!container.contains(e.target)) {
                select.style.display = 'none';
            }
        });
        
        function updateHiddenInput() {
            const badges = selectedContainer.querySelectorAll('.badge');
            const values = Array.from(badges).map(b => b.textContent.trim());
            hiddenInput.value = values.join(',');
        }
    });
});
</script>